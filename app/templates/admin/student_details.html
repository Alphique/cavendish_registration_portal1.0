<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Student Details - Admin</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* 
        STUDENT DETAILS TEMPLATE - ADMIN VIEW
        This template displays student information, payment history, and allows viewing of submitted documents.
        
        KEY FEATURES:
        1. Student profile display
        2. Payment history with status tracking
        3. Document preview system (images + PDFs)
        4. In-line payment approval/rejection
        5. Responsive design for all devices
        */
        
        /* Full-screen modal for better document viewing */
        .modal-fullscreen-custom {
            max-width: 95vw;  /* Use 95% of viewport width */
            width: 95vw;
            height: 95vh;     /* Use 95% of viewport height */
            margin: 2.5vh auto; /* Center with small margin */
        }
        
        /* File preview containers */
        .file-preview {
            max-height: 85vh;  /* Larger preview area */
            width: 100%;
            object-fit: contain; /* Maintain aspect ratio */
        }
        
        .pdf-preview {
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            height: 85vh;     /* Fixed height for PDFs */
        }
        
        .image-preview {
            max-height: 85vh;
            width: auto;
            max-width: 100%;
        }
        
        /* Modal content area */
        .modal-body-custom {
            padding: 0;       /* Remove padding for full-bleed content */
            background-color: #f8f9fa; /* Light background for better contrast */
        }
    </style>
</head>
<body class="bg-light">

<!-- 
NAVIGATION BAR
- Provides easy navigation back to dashboard
- Uses Bootstrap navbar component
-->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container">
        <a class="navbar-brand" href="{{ url_for('admin.dashboard') }}">
            <i class="fas fa-university me-2"></i>Cavendish University Admin
        </a>
        <div class="navbar-nav ms-auto">
            <a class="nav-link" href="{{ url_for('admin.dashboard') }}">
                <i class="fas fa-arrow-left me-1"></i>Back to Dashboard
            </a>
        </div>
    </div>
</nav>

<!-- 
MAIN CONTENT CONTAINER
- Uses Bootstrap grid system for responsive layout
- Divided into three main sections
-->
<div class="container mt-4">
    
    <!-- 
    FLASH MESSAGES SECTION
    - Displays success/error messages from Flask flash()
    - Uses Bootstrap alert components
    -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <!-- 
    STUDENT INFORMATION CARD
    - Displays student personal and academic details
    - Split into two columns for better organization
    -->
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h4 class="mb-0">
                <i class="fas fa-user-graduate me-2"></i>Student Information
            </h4>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <p><strong>Name:</strong> {{ student.name }}</p>
                    <p><strong>Student Number:</strong> {{ student.student_number }}</p>
                    <p><strong>Email:</strong> {{ student.email or 'Not provided' }}</p>
                    <p><strong>Phone:</strong> {{ student.phone or 'Not provided' }}</p>
                </div>
                <div class="col-md-6">
                    <p><strong>Program:</strong> {{ student.program or 'Not specified' }}</p>
                    <p><strong>Faculty:</strong> {{ student.faculty or 'Not specified' }}</p>
                    <p><strong>Intake Year:</strong> {{ student.intake_year or 'Not specified' }}</p>
                    <p><strong>Year of Study:</strong> {{ student.year_of_study or 'Not specified' }}</p>
                    <p><strong>Semester:</strong> {{ student.semester or 'Not specified' }}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- 
    PAYMENT HISTORY CARD
    - Displays all payment records in a table
    - Includes status badges and action buttons
    -->
    <div class="card mb-4">
        <div class="card-header bg-info text-white">
            <h4 class="mb-0">
                <i class="fas fa-receipt me-2"></i>Payment History
            </h4>
        </div>
        <div class="card-body">
            {% if payments %}
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Reference</th>
                                <th>Amount</th>
                                <th>Status</th>
                                <th>Submitted Date</th>
                                <th>Approved Date</th>
                                <th>Payment Slip</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for payment in payments %}
                            <tr>
                                <!-- Payment Reference -->
                                <td><code>{{ payment.reference }}</code></td>
                                
                                <!-- Amount with null check -->
                                <td>
                                    {% if payment.amount is not none %}
                                        ZMW {{ "%.2f"|format(payment.amount) }}
                                    {% else %}
                                        <span class="text-muted">Not specified</span>
                                    {% endif %}
                                </td>
                                
                                <!-- Status with color-coded badge -->
                                <td>
                                    <span class="badge 
                                        {% if payment.status == 'approved' %}bg-success
                                        {% elif payment.status == 'rejected' %}bg-danger
                                        {% else %}bg-warning text-dark{% endif %}">
                                        {{ payment.status|title }}
                                    </span>
                                </td>
                                
                                <!-- Submission and approval dates -->
                                <td>{{ payment.submitted_date.strftime('%Y-%m-%d %H:%M') }}</td>
                                <td>
                                    {% if payment.approved_date %}
                                        {{ payment.approved_date.strftime('%Y-%m-%d %H:%M') }}
                                    {% else %}
                                        <span class="text-muted">N/A</span>
                                    {% endif %}
                                </td>
                                
                                <!-- Document preview button -->
                                <td>
                                    {% if payment.slip_filename %}
                                        <button class="btn btn-sm btn-outline-primary view-slip" 
                                                data-filename="{{ payment.slip_filename }}"
                                                data-filetype="{{ payment.slip_filename.split('.')[-1].lower() }}"
                                                data-bs-toggle="modal" 
                                                data-bs-target="#slipModal">
                                            <i class="fas fa-eye me-1"></i>View Slip
                                        </button>
                                    {% else %}
                                        <span class="text-muted">No slip</span>
                                    {% endif %}
                                </td>
                                
                                <!-- Action buttons for pending payments -->
                                <td>
                                    {% if payment.status == 'pending' %}
                                    <div class="btn-group btn-group-sm">
                                        <a href="{{ url_for('admin.manage_payment', payment_id=payment.id, action='approve') }}" 
                                           class="btn btn-outline-success" title="Approve Payment">
                                            <i class="fas fa-check"></i>
                                        </a>
                                        <a href="{{ url_for('admin.manage_payment', payment_id=payment.id, action='reject') }}" 
                                           class="btn btn-outline-danger" title="Reject Payment">
                                            <i class="fas fa-times"></i>
                                        </a>
                                    </div>
                                    {% else %}
                                        <span class="text-muted">Processed</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <p class="text-muted text-center">No payment history found.</p>
            {% endif %}
        </div>
    </div>

    <!-- 
    REGISTRATION SLIP CARD
    - Displays registration slip information if available
    - Includes download link for PDF
    -->
    {% if registration_slip %}
    <div class="card">
        <div class="card-header bg-success text-white">
            <h4 class="mb-0">
                <i class="fas fa-file-contract me-2"></i>Registration Slip
            </h4>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <p><strong>Slip Number:</strong> {{ registration_slip.slip_number }}</p>
                    <p><strong>Issue Date:</strong> {{ registration_slip.issue_date.strftime('%Y-%m-%d') }}</p>
                    <p><strong>Created By:</strong> {{ registration_slip.created_by or 'System' }}</p>
                </div>
                <div class="col-md-6">
                    <p><strong>Academic Year:</strong> {{ registration_slip.academic_year or 'Not specified' }}</p>
                    <p><strong>Semester:</strong> {{ registration_slip.semester or 'Not specified' }}</p>
                    <p><strong>Program:</strong> {{ registration_slip.program_name or student.program or 'Not specified' }}</p>
                    <p><strong>Faculty:</strong> {{ registration_slip.faculty_name or student.faculty or 'Not specified' }}</p>
                </div>
            </div>
            {% if registration_slip.pdf_filename %}
            <div class="mt-3">
                <a href="{{ url_for('admin.serve_uploaded_file', filename=registration_slip.pdf_filename) }}" 
                   class="btn btn-primary" target="_blank">
                    <i class="fas fa-download me-1"></i>Download Registration Slip PDF
                </a>
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}
</div>

<!-- 
DOCUMENT PREVIEW MODAL
- Full-screen modal for viewing payment slips
- Handles multiple file types (images, PDFs, others)
- Uses JavaScript for dynamic content loading
-->
<div class="modal fade" id="slipModal" tabindex="-1" aria-labelledby="slipModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen-custom">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="slipModalLabel">Payment Slip Preview</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body modal-body-custom text-center">
                
                <!-- Image Preview Section -->
                <div id="imagePreview" style="display: none;">
                    <img id="slipImage" src="" alt="Payment Slip" class="file-preview image-preview">
                </div>
                
                <!-- PDF Preview Section -->
                <div id="pdfPreview" style="display: none;">
                    <iframe id="pdfFrame" src="" class="file-preview pdf-preview" frameborder="0"></iframe>
                </div>
                
                <!-- Unsupported File Type Section -->
                <div id="unsupportedPreview" style="display: none;">
                    <div class="alert alert-warning m-4">
                        <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
                        <h5>File Preview Not Available</h5>
                        <p>This file type cannot be previewed in the browser.</p>
                        <p>Please download the file to view it.</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <a id="downloadSlip" href="#" class="btn btn-primary" download>
                    <i class="fas fa-download me-1"></i>Download
                </a>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- 
JAVASCRIPT FUNCTIONALITY
- Handles document preview loading
- Manages file type detection
- Controls modal behavior
-->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Handle payment slip viewing when "View Slip" button is clicked
    document.querySelectorAll('.view-slip').forEach(button => {
        button.addEventListener('click', function() {
            // Get file information from data attributes
            const filename = this.getAttribute('data-filename');
            const filetype = this.getAttribute('data-filetype');
            const slipUrl = "{{ url_for('admin.serve_uploaded_file', filename='') }}" + filename;
            
            console.log('Loading document:', filename, 'Type:', filetype); // Debug log
            
            // Hide all preview sections first
            document.getElementById('imagePreview').style.display = 'none';
            document.getElementById('pdfPreview').style.display = 'none';
            document.getElementById('unsupportedPreview').style.display = 'none';
            
            // Show appropriate preview based on file type
            if (['jpg', 'jpeg', 'png', 'gif', 'webp', 'bmp'].includes(filetype)) {
                // Image files - display in img tag
                document.getElementById('slipImage').src = slipUrl;
                document.getElementById('imagePreview').style.display = 'block';
                console.log('Displaying as image');
            } else if (filetype === 'pdf') {
                // PDF files - display in iframe
                document.getElementById('pdfFrame').src = slipUrl + '#view=FitH';
                document.getElementById('pdfPreview').style.display = 'block';
                console.log('Displaying as PDF');
            } else {
                // Unsupported file types - show message
                document.getElementById('unsupportedPreview').style.display = 'block';
                console.log('Unsupported file type');
            }
            
            // Set download link for all file types
            document.getElementById('downloadSlip').href = slipUrl;
            document.getElementById('downloadSlip').download = filename;
        });
    });

    // Clear modal content when closed to free memory
    document.getElementById('slipModal').addEventListener('hidden.bs.modal', function () {
        document.getElementById('slipImage').src = '';
        document.getElementById('pdfFrame').src = '';
        console.log('Modal closed - content cleared');
    });
</script>
</body>
</html>